<!--
@license
Copyright (c) 2017 Swarm City
This code may only be used under the license found at https://github.com/swarmcity/license
-->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../data/data-local-storage.html">
<!--

Example:
```
<display-language></display-language>
```

-->
<dom-module id="display-language">
    <template>
        <style>
            :host {
                display: block;
            }
            .big-btn{
                @apply(--big-btn)
            }
        </style>
        <data-local-storage id="localStorage"></data-local-storage>
        <template is="dom-if" if="{{selected}}">
            <div on-click="_routeLanguages">
                {{language}}
            </div>
        </template>
        <template is="dom-if" if="{{buttons}}">
            <template is="dom-repeat" items="{{locales}}">
                <div class="big-btn" on-click="_selectLanguage">
                    {{item}}
                </div>
            </template>   
        </template>
    </template>
    <script>

class DisplayLanguage extends Polymer.Element {
        static get is() { return 'display-language';}
        static get properties() { return {
            language: {
                type: String,
                notify: true,
            },
            selected: {
                type: Boolean,
                value: false,
            },
            buttons: {
                type: Boolean,
                value: false,
            },
            path: {
                type: String,
                value: null,
                notify: true,
            },
            route: {
                type: Object,
                observer: '_routeChanged',
            },
        };
    }
    connectedCallback() {
        super.connectedCallback();

        this._allLanguages();
        this.$.localStorage.accountExists()
        .then((account) => {
            this.account = account;
            if(!account.language) {
                const str = navigator.language || navigator.userLanguage;
                const res = str.split('-');
                const language = res[0];
                return language;
            } else {
                const language = account.language;
                return language;
            }
        })
        .then((language) => {
            return this._translationExists(language);
        })
        .then((data) => {
            this.language = data.language;
            this.$.localStorage.saveAccount({language: data.language});
        })
        .catch((err) => {
            this.language = 'en';
        });
    }

    _routeChanged() {
        this.$.localStorage.accountExists()
        .then((account) => {
            this.language = account.language;
        });
    }

    _selectLanguage(event) {
        let account = this.account;
        account.language = this.iso[event.model.__data.index];
        this.$.localStorage.saveAccount(account);
        this.language = this.iso[event.model.__data.index];
        this.path = '/';
    }

    _routeLanguages() {
        this.path = 'language/';
    }

    _translationExists(language) {
        return new Promise((resolve, reject) => {
            const xobj = new XMLHttpRequest();
            xobj.overrideMimeType('application/json');
            xobj.open('GET', '../src/text-translations.json', true);
            xobj.onreadystatechange = () => {
                if (xobj.readyState == 4 && xobj.status == '200') {
                    const json = JSON.parse(xobj.responseText);
                    this.languages = json;
                    const keys = Object.keys(json);
                    const arr = keys.indexOf(language);
                    if(arr != -1) {
                        resolve({language: language, found: true});
                    } else {
                        resolve({language: language, found: false});
                    }
                }
            };
            xobj.send(null);
        });
    }

        _allLanguages() {
            return new Promise((resolve, reject) => {
                const xobj = new XMLHttpRequest();
                xobj.overrideMimeType('application/json');
                xobj.open('GET', '../src/text-translations.json', true);
                xobj.onreadystatechange = () => {
                    if (xobj.readyState == 4 && xobj.status == '200') {
                        const json = JSON.parse(xobj.responseText);
                        const count = (Object.keys(json).length);
                        this.locales = [];
                        this.iso = [];
                        var i;
                        for (i = 0; i < count; i++) {
                        this.locales.push(json[Object.keys(json)[i]].locale);
                        this.iso.push(json[Object.keys(json)[i]].language);
                        }
                        resolve(this.locales);
                    }
                };
            xobj.send(null);
        });
    }

} window.customElements.define(DisplayLanguage.is,
DisplayLanguage);
</script>
</dom-module>
